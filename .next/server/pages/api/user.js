"use strict";(()=>{var e={};e.id=541,e.ids=[541],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2021:e=>{e.exports=import("i18next")},7987:e=>{e.exports=import("react-i18next")},8210:e=>{e.exports=import("sequelize")},3843:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>c,routeModule:()=>d});var s=r(808),i=r(7933),n=r(6130),u=r(6014),o=e([u]);u=(o.then?(await o)():o)[0];let c=(0,n.l)(u,"default"),l=(0,n.l)(u,"config"),d=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/user",pathname:"/api/user",bundlePath:"",filename:""},userland:u});a()}catch(e){a(e)}})},6014:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>d});var s=r(4570),i=r(4229),n=r(5076),u=r(2550),o=r(8059),c=r(2901),l=e([s,i,n,u,o]);async function d(e,t){if("GET"==e.method){n.Z.changeLanguage(e.query.lang||"en");let l=await u.r.checkToken(e.query.token)||-1;if(-1==l){s.b.failure(t,n.Z.t("unauthorized"));return}let d=e.query.userIdList;var r=[];if("string"==typeof d)for(let e of d.split(",")){if(!c.h.isValidNumber(e)){s.b.failure(t,n.Z.t("invalidParameter"));return}r.push(parseInt(e))}if(0==r.length&&!1==(await o.r.getPermission(l)).checkPermission(o.r.PERMISSION_LIST_USER)){s.b.failure(t,n.Z.t("permissionDenied"));return}var a=[];await i.VK.findAll({...r.length>0&&{where:{userId:r}}}).then(e=>{for(let t of e)a.push({userId:t.getDataValue("userId"),username:t.getDataValue("username"),studentId:t.getDataValue("studentId"),permission:t.getDataValue("permission"),lastOnline:t.getDataValue("lastOnline")})}).catch(e=>{console.error(e.name+"  "+e.message),s.b.failure(t,n.Z.t("databaseError"))}),s.b.success(t,n.Z.t("userGetSuccess"),{user:a})}else if("POST"==e.method){let r=e.body;n.Z.changeLanguage(r.lang||"en");let a=await u.r.checkToken(r.token)||-1;if(-1==a){s.b.failure(t,n.Z.t("unauthorized"));return}let c=r.params.username,l=r.params.password,d=r.params.studentId,m=r.params.permission;if("string"!=typeof c||"string"!=typeof l||"number"!=typeof d||"number"!=typeof m){s.b.failure(t,n.Z.t("invalidParameter"));return}if(!1==(await o.r.getPermission(a)).checkPermission(o.r.PERMISSION_CREATE_USER)){s.b.failure(t,n.Z.t("permissionDenied"));return}await i.VK.count({where:{username:c}})&&s.b.failure(t,n.Z.t("userExists")),await i.VK.create({username:c,password:l,studentId:d,permission:m}).then(()=>{s.b.success(t,n.Z.t("userCreateSuccess"))}).catch(e=>{console.error(e.name+"  "+e.message),s.b.failure(t,n.Z.t("databaseError"))})}else if("PUT"==e.method){let r=e.body;n.Z.changeLanguage(r.lang||"en");let a=await u.r.checkToken(r.token)||-1;var l="";-1!==a&&await i.VK.findOne({where:{userId:a}}).then(e=>{if(!e){s.b.failure(t,n.Z.t("userNotFound"));return}l=e.getDataValue("username")}).catch(()=>{l=""});let c=r.params.username,d=r.params.password,m=r.params.userId,h=r.params.permission;if("string"==typeof c&&"string"==typeof d){if(c!==l&&!1==(await o.r.getPermission(a)).checkPermission(o.r.PERMISSION_UPDATE_OTHER_PASSWORD)){s.b.failure(t,n.Z.t("permissionDenied"));return}await i.VK.update({password:d},{where:{username:c}}).then(()=>{s.b.success(t,n.Z.t("userUpdateSuccess"))}).catch(e=>{console.error(e),s.b.failure(t,n.Z.t("databaseError"))})}else if("number"==typeof m&&"number"==typeof h){if(!1==(await o.r.getPermission(a)).checkPermission(o.r.PERMISSION_UPDATE_PRIVILEGE)){s.b.failure(t,n.Z.t("permissionDenied"));return}await i.VK.update({permission:h},{where:{userId:m}}).then(()=>{s.b.success(t,n.Z.t("userUpdateSuccess"))}).catch(e=>{console.error(e),s.b.failure(t,n.Z.t("databaseError"))})}else s.b.failure(t,n.Z.t("invalidParameter"))}else if("DELETE"==e.method){if(n.Z.changeLanguage(e.query.lang||"en"),await u.r.checkToken(e.query.token)==null){s.b.failure(t,n.Z.t("unauthorized"));return}let r=e.query.userId;if("string"!=typeof r||!c.h.isValidNumber(r)){s.b.failure(t,n.Z.t("invalidParameter"));return}await i.VK.destroy({where:{userId:r}}).then(()=>{s.b.success(t,n.Z.t("userDeleteSuccess"))}).catch(e=>{console.error(e.name+"  "+e.message),s.b.failure(t,n.Z.t("databaseError"))})}else s.b.failure(t,n.Z.t("invalidMethod"))}[s,i,n,u,o]=l.then?(await l)():l,a()}catch(e){a(e)}})},8059:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{r:()=>n});var s=r(4229),i=e([s]);s=(i.then?(await i)():i)[0];class n{static{this.PERMISSION_LOGIN=0}static{this.PERMISSION_FINANCE_WRITE=1}static{this.PERMISSION_CREATE_USER=2}static{this.PERMISSION_LIST_USER=3}static{this.PERMISSION_UPDATE_OTHER_PASSWORD=4}static{this.PERMISSION_UPDATE_PRIVILEGE=5}constructor(e){this.permissionNumber=e}static async getPermission(e){let t=0;return await s.VK.findOne({where:{userId:e}}).then(e=>{e&&(t=e.getDataValue("permission"))}).catch(()=>{t=0}),new n(t)}checkPermission(e){return(this.permissionNumber&1<<e)!=0}addPermission(e){this.permissionNumber|=1<<e}removePermission(e){this.permissionNumber&=~(1<<e)}}a()}catch(e){a(e)}})},2550:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{r:()=>n});var s=r(4229),i=e([s]);s=(i.then?(await i)():i)[0];class n{static async checkToken(e){return await s.Qw.findOne({where:{token:e}}).then(async e=>{if(!e)return null;let t=e.getDataValue("userId");return await s.VK.update({lastOnline:new Date},{where:{userId:t}}),t}).catch(()=>null)}}a()}catch(e){a(e)}})},2901:(e,t,r)=>{r.d(t,{h:()=>a});class a{static isValidNumber(e,t=!1){let r=parseInt(e);return!isNaN(r)&&(t||r>=0)&&r!=-1/0&&r!=1/0}}}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[840],()=>r(3843));module.exports=a})();